@using ObservableUI.Services
@using System.Reactive.Linq
@inject CombiningService CombiningService
@implements IDisposable

<div class="combining-section">
    <h3 class="section-title">ğŸ”— ØªØ±Ú©ÛŒØ¨ Observables / Combining Observables</h3>

    <div class="controls">
        <button class="btn btn-primary" @onclick="StartAllSensors">
            @(isSensorsActive ? "ØªÙˆÙ‚Ù Ø³Ù†Ø³ÙˆØ±Ù‡Ø§" : "Ø´Ø±ÙˆØ¹ Ø³Ù†Ø³ÙˆØ±Ù‡Ø§") /
            @(isSensorsActive ? "Stop Sensors" : "Start Sensors")
        </button>

        <button class="btn btn-success" @onclick="StartEvents">
            @(isEventsActive ? "ØªÙˆÙ‚Ù Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§" : "Ø´Ø±ÙˆØ¹ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§") /
            @(isEventsActive ? "Stop Events" : "Start Events")
        </button>
    </div>

    <div class="data-display">
        @if (mergedTemperatures.Any())
        {
            <div class="data-panel">
                <h4>ğŸŒ¡ï¸ Ø¯Ù…Ø§Ù‡Ø§ÛŒ Ø§Ø¯ØºØ§Ù… Ø´Ø¯Ù‡ (Merge) / Merged Temperatures (Merge)</h4>
                <div class="data-list">
                    @foreach (var temp in mergedTemperatures.Take(8))
                    {
                        <div class="data-item temp-item">
                            <strong>@temp.SensorId</strong>
                            <span>@temp.Value.ToString("F1")Â°C</span>
                            <small>@temp.Timestamp.ToString("HH:mm:ss")</small>
                        </div>
                    }
                </div>
            </div>
        }

        @if (environmentalData.Any())
        {
            <div class="data-panel">
                <h4>ğŸï¸ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø­ÛŒØ·ÛŒ (CombineLatest) / Environmental Data (CombineLatest)</h4>
                <div class="data-list">
                    @foreach (var env in environmentalData.Take(6))
                    {
                        <div class="data-item env-item">
                            <span>T1: @env.Temperature1.ToString("F1")Â°C</span>
                            <span>T2: @env.Temperature2.ToString("F1")Â°C</span>
                            <span>Avg: @env.AverageTemperature.ToString("F1")Â°C</span>
                            <span>Hum: @env.Humidity.ToString("F1")%</span>
                            <small>@env.Timestamp.ToString("HH:mm:ss")</small>
                        </div>
                    }
                </div>
            </div>
        }

        @if (orderPayments.Any())
        {
            <div class="data-panel">
                <h4>ğŸ’³ Ø³ÙØ§Ø±Ø´Ø§Øª Ùˆ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ (Zip) / Orders and Payments (Zip)</h4>
                <div class="data-list">
                    @foreach (var pair in orderPayments.Take(6))
                    {
                        <div class="data-item payment-item">
                            <strong>@pair.OrderId</strong>
                            <span>@pair.PaymentMethod</span>
                            <span>$@pair.Amount.ToString("F2")</span>
                            <span class="status">@pair.PaymentStatus</span>
                            <small>@pair.Timestamp.ToString("HH:mm:ss")</small>
                        </div>
                    }
                </div>
            </div>
        }

        @if (concatenatedMetrics.Any())
        {
            <div class="data-panel">
                <h4>ğŸ“Š Ù…ØªØ±ÛŒÚ©â€ŒÙ‡Ø§ÛŒ Ø²Ù†Ø¬ÛŒØ±Ù‡â€ŒØ§ÛŒ (Concat) / Concatenated Metrics (Concat)</h4>
                <div class="data-list">
                    @foreach (var metric in concatenatedMetrics.Take(9))
                    {
                        <div class="data-item metric-item">
                            <strong>@metric.Type</strong>
                            <span>@metric.Value%</span>
                            <small>@metric.Timestamp.ToString("HH:mm:ss")</small>
                        </div>
                    }
                </div>
            </div>
        }

        @if (mergedSystemEvents.Any())
        {
            <div class="data-panel">
                <h4>âš ï¸ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ… Ø§Ø¯ØºØ§Ù… Ø´Ø¯Ù‡ (Merge) / Merged System Events (Merge)</h4>
                <div class="data-list">
                    @foreach (var sysEvent in mergedSystemEvents.Take(8))
                    {
                        <div class="data-item system-event-item">
                            <span class="severity @sysEvent.Severity.ToLower()">[@sysEvent.Severity]</span>
                            <span>@sysEvent.Source</span>
                            <span>@sysEvent.Message</span>
                            <small>@sysEvent.Timestamp.ToString("HH:mm:ss")</small>
                        </div>
                    }
                </div>
            </div>
        }

        @if (ambTemperatures.Any())
        {
            <div class="data-panel">
                <h4>ğŸ¯ Ø¯Ù…Ø§Ù‡Ø§ Ø¨Ø§ Amb / Temperatures with Amb</h4>
                <div class="data-list">
                    @foreach (var temp in ambTemperatures.Take(5))
                    {
                        <div class="data-item amb-item">
                            <strong>@temp.SensorId</strong>
                            <span>@temp.Value.ToString("F1")Â°C</span>
                            <small>@temp.Timestamp.ToString("HH:mm:ss")</small>
                        </div>
                    }
                </div>
                <div class="amb-info">
                    <small>Amb Ø§ÙˆÙ„ÛŒÙ† Ø³Ù†Ø³ÙˆØ±ÛŒ Ø±Ø§ Ú©Ù‡ Ù…Ù‚Ø¯Ø§Ø± Ø§Ø±Ø³Ø§Ù„ Ú©Ù†Ø¯ØŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù…ÛŒâ€ŒÚ©Ù†Ø¯</small><br>
                    <small>Amb selects the first sensor that emits a value</small>
                </div>
            </div>
        }

        @if (userActivityStats.Any())
        {
            <div class="data-panel">
                <h4>ğŸ“ˆ Ø¢Ù…Ø§Ø± ÙØ¹Ø§Ù„ÛŒØª ØªØ±Ú©ÛŒØ¨ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† / Combined User Activity Stats</h4>
                <div class="data-list">
                    @foreach (var stat in userActivityStats.Take(6))
                    {
                        <div class="data-item activity-stat-item">
                            <strong>@stat.UserId</strong>
                            <span>@stat.TimeToPurchase.ToString("F1") Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ§ Ø®Ø±ÛŒØ¯</span>
                            <small>Login: @stat.LastLogin.ToString("HH:mm:ss")</small>
                            <small>Purchase: @stat.LastPurchase.ToString("HH:mm:ss")</small>
                        </div>
                    }
                </div>
            </div>
        }

        @if (joinedCorrelations.Any())
        {
            <div class="data-panel">
                <h4>ğŸ” Ù‡Ù…Ø¨Ø³ØªÚ¯ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ (Join) / Data Correlation (Join)</h4>
                <div class="data-list">
                    @foreach (var correlation in joinedCorrelations.Take(6))
                    {
                        <div class="data-item correlation-item">
                            <strong>@correlation.UserId</strong>
                            <span>@correlation.Action</span>
                            <span>@correlation.MetricType: @correlation.MetricValue%</span>
                            <small>User: @correlation.UserTimestamp.ToString("HH:mm:ss")</small>
                            <small>Metric: @correlation.MetricTimestamp.ToString("HH:mm:ss")</small>
                        </div>
                    }
                </div>
            </div>
        }
    </div>

    <div class="info-panel">
        <p>
            <strong>Ù…ÙØ§Ù‡ÛŒÙ… Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡:</strong><br>
            - Merge Ø¨Ø±Ø§ÛŒ ØªØ±Ú©ÛŒØ¨ Ø¬Ø±ÛŒØ§Ù†â€ŒÙ‡Ø§ÛŒ Ù‡Ù…Ø²Ù…Ø§Ù†<br>
            - CombineLatest Ø¨Ø±Ø§ÛŒ Ø¢Ø®Ø±ÛŒÙ† Ù…Ù‚Ø¯Ø§Ø± Ù‡Ø± Ø¬Ø±ÛŒØ§Ù†<br>
            - Zip Ø¨Ø±Ø§ÛŒ Ø¬ÙØª Ú©Ø±Ø¯Ù† Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ±ØªÛŒØ¨<br>
            - Concat Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ Ù…ØªÙˆØ§Ù„ÛŒ<br>
            - Amb Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø§ÙˆÙ„ÛŒÙ† Ø¬Ø±ÛŒØ§Ù†<br>
            - Join Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ø¨Ø³ØªÚ¯ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
        </p>
        <p>
            <strong>Concepts demonstrated:</strong><br>
            - Merge for combining concurrent streams<br>
            - CombineLatest for latest value from each stream<br>
            - Zip for pairing by order<br>
            - Concat for sequential execution<br>
            - Amb for selecting first stream<br>
            - Join for data correlation
        </p>
    </div>
</div>

<style>
.combining-section {
    margin: 20px 0;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background-color: #f9f9f9;
}

.section-title {
    color: #2c3e50;
    margin-bottom: 15px;
    text-align: center;
}

.controls {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    justify-content: center;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.3s;
}

.btn-primary { background-color: #007bff; color: white; }
.btn-primary:hover { background-color: #0056b3; }

.btn-success { background-color: #28a745; color: white; }
.btn-success:hover { background-color: #1e7e34; }

.data-display {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.data-panel {
    background: white;
    padding: 15px;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.data-panel h4 {
    margin: 0 0 10px 0;
    color: #495057;
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 5px;
}

.data-list {
    max-height: 200px;
    overflow-y: auto;
}

.data-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
    margin: 4px 0;
    background: #f8f9fa;
    border-radius: 4px;
    border-left: 4px solid #6c757d;
    flex-wrap: wrap;
    gap: 5px;
}

.temp-item { border-left-color: #007bff; }
.env-item { border-left-color: #28a745; }
.payment-item { border-left-color: #17a2b8; }
.metric-item { border-left-color: #ffc107; }
.system-event-item { border-left-color: #dc3545; }
.amb-item { border-left-color: #6f42c1; }
.activity-stat-item { border-left-color: #e83e8c; }
.correlation-item { border-left-color: #20c997; }

.status {
    background-color: #e9ecef;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.8em;
    font-weight: bold;
}

.status:contains("COMPLETED") { background-color: #d4edda; color: #155724; }
.status:contains("PENDING") { background-color: #fff3cd; color: #856404; }
.status:contains("FAILED") { background-color: #f8d7da; color: #721c24; }

.severity {
    font-weight: bold;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.8em;
}

.severity.high { background-color: #f8d7da; color: #721c24; }
.severity.normal { background-color: #d1ecf1; color: #0c5460; }

.amb-info {
    margin-top: 10px;
    padding: 8px;
    background: #e7f3ff;
    border-radius: 4px;
    text-align: center;
    color: #495057;
}

.data-item small {
    color: #6c757d;
    font-size: 0.8em;
    flex-basis: 100%;
}

.info-panel {
    background: #e7f3ff;
    padding: 15px;
    border-radius: 6px;
    border-left: 4px solid #007bff;
}

.info-panel p {
    margin: 5px 0;
    line-height: 1.6;
}
</style>

@code {
    private List<TemperatureReading> mergedTemperatures = new();
    private List<EnvironmentalData> environmentalData = new();
    private List<OrderPaymentPair> orderPayments = new();
    private List<SystemMetric> concatenatedMetrics = new();
    private List<SystemEventCombined> mergedSystemEvents = new();
    private List<TemperatureReading> ambTemperatures = new();
    private List<UserActivityCombined> userActivityStats = new();
    private List<UserSystemCorrelation> joinedCorrelations = new();

    private bool isSensorsActive;
    private bool isEventsActive;

    private IDisposable? mergedTempSubscription;
    private IDisposable? envDataSubscription;
    private IDisposable? orderPaymentSubscription;
    private IDisposable? concatenatedSubscription;
    private IDisposable? mergedEventsSubscription;
    private IDisposable? ambTempSubscription;
    private IDisposable? userActivitySubscription;
    private IDisposable? joinedCorrelationSubscription;

    protected override void OnInitialized()
    {
        // Initialize subscriptions
        mergedTempSubscription = CombiningService.MergedTemperatureReadings.Subscribe(temp =>
        {
            InvokeAsync(() =>
            {
                mergedTemperatures.Insert(0, temp);
                if (mergedTemperatures.Count > 15) mergedTemperatures.RemoveAt(15);
                StateHasChanged();
            });
        });

        envDataSubscription = CombiningService.CombinedEnvironmentalData.Subscribe(env =>
        {
            InvokeAsync(() =>
            {
                environmentalData.Insert(0, env);
                if (environmentalData.Count > 15) environmentalData.RemoveAt(15);
                StateHasChanged();
            });
        });

        orderPaymentSubscription = CombiningService.ZippedOrderPayments.Subscribe(pair =>
        {
            InvokeAsync(() =>
            {
                orderPayments.Insert(0, pair);
                if (orderPayments.Count > 15) orderPayments.RemoveAt(15);
                StateHasChanged();
            });
        });

        concatenatedSubscription = CombiningService.ConcatenatedSystemMetrics.Subscribe(metric =>
        {
            InvokeAsync(() =>
            {
                concatenatedMetrics.Add(metric);
                if (concatenatedMetrics.Count > 15) concatenatedMetrics.RemoveAt(0);
                StateHasChanged();
            });
        });

        mergedEventsSubscription = CombiningService.MergedSystemEvents.Subscribe(sysEvent =>
        {
            InvokeAsync(() =>
            {
                mergedSystemEvents.Insert(0, sysEvent);
                if (mergedSystemEvents.Count > 15) mergedSystemEvents.RemoveAt(15);
                StateHasChanged();
            });
        });

        ambTempSubscription = CombiningService.AmbTemperatureReadings.Subscribe(temp =>
        {
            InvokeAsync(() =>
            {
                ambTemperatures.Insert(0, temp);
                if (ambTemperatures.Count > 15) ambTemperatures.RemoveAt(15);
                StateHasChanged();
            });
        });

        userActivitySubscription = CombiningService.CombinedUserActivityStats.Subscribe(stat =>
        {
            InvokeAsync(() =>
            {
                userActivityStats.Insert(0, stat);
                if (userActivityStats.Count > 15) userActivityStats.RemoveAt(15);
                StateHasChanged();
            });
        });

        joinedCorrelationSubscription = CombiningService.JoinedUserSystemData.Subscribe(correlation =>
        {
            InvokeAsync(() =>
            {
                joinedCorrelations.Insert(0, correlation);
                if (joinedCorrelations.Count > 15) joinedCorrelations.RemoveAt(15);
                StateHasChanged();
            });
        });
    }

    private void StartAllSensors()
    {
        if (isSensorsActive)
        {
            isSensorsActive = false;
        }
        else
        {
            CombiningService.StartAllSensors();
            isSensorsActive = true;
        }
    }

    private void StartEvents()
    {
        if (isEventsActive)
        {
            isEventsActive = false;
        }
        else
        {
            CombiningService.StartEvents();
            isEventsActive = true;
        }
    }

    public void Dispose()
    {
        mergedTempSubscription?.Dispose();
        envDataSubscription?.Dispose();
        orderPaymentSubscription?.Dispose();
        concatenatedSubscription?.Dispose();
        mergedEventsSubscription?.Dispose();
        ambTempSubscription?.Dispose();
        userActivitySubscription?.Dispose();
        joinedCorrelationSubscription?.Dispose();
    }
}


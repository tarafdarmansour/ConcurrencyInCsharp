@using ObservableUI.Services
@using System.Reactive.Linq
@inject EventService EventService
@implements IDisposable

<div class="event-section">
    <h3 class="section-title">ğŸ¯ Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ / Event Handling</h3>

    <div class="controls">
        <button class="btn btn-primary" @onclick="StartUserActions">
            @(isUserActionsActive ? "ØªÙˆÙ‚Ù Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±" : "Ø´Ø±ÙˆØ¹ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±") /
            @(isUserActionsActive ? "Stop User Actions" : "Start User Actions")
        </button>

        <button class="btn btn-info" @onclick="StartSystemEvents">
            @(isSystemEventsActive ? "ØªÙˆÙ‚Ù Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…" : "Ø´Ø±ÙˆØ¹ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…") /
            @(isSystemEventsActive ? "Stop System Events" : "Start System Events")
        </button>

        <button class="btn btn-secondary" @onclick="StartOrderEvents">
            @(isOrderEventsActive ? "ØªÙˆÙ‚Ù Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø³ÙØ§Ø±Ø´" : "Ø´Ø±ÙˆØ¹ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø³ÙØ§Ø±Ø´") /
            @(isOrderEventsActive ? "Stop Order Events" : "Start Order Events")
        </button>

        <button class="btn btn-warning" @onclick="SimulateButtonClick">
            Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ù„ÛŒÚ© Ø¯Ú©Ù…Ù‡ / Simulate Button Click
        </button>
    </div>

    <div class="data-display">
        @if (userActions.Any())
        {
            <div class="data-panel">
                <h4>ğŸ‘¤ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± / User Actions</h4>
                <div class="data-list">
                    @foreach (var action in userActions.Take(8))
                    {
                        <div class="data-item user-action-item">
                            <strong>@action.UserId</strong>
                            <span class="action-type">@action.ActionType</span>
                            <span>@action.PageUrl</span>
                            <small>@action.Timestamp.ToString("HH:mm:ss")</small>
                        </div>
                    }
                </div>
            </div>
        }

        @if (systemEvents.Any())
        {
            <div class="data-panel">
                <h4>âš™ï¸ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ… / System Events</h4>
                <div class="data-list">
                    @foreach (var sysEvent in systemEvents.Take(8))
                    {
                        <div class="data-item system-event-item">
                            <span class="event-type @sysEvent.Type.ToLower()">[@sysEvent.Type]</span>
                            <span>@sysEvent.Message</span>
                            <small>@sysEvent.Component</small>
                            <small>@sysEvent.Timestamp.ToString("HH:mm:ss")</small>
                        </div>
                    }
                </div>
            </div>
        }

        @if (orderEvents.Any())
        {
            <div class="data-panel">
                <h4>ğŸ“¦ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø³ÙØ§Ø±Ø´ / Order Events</h4>
                <div class="data-list">
                    @foreach (var order in orderEvents.Take(8))
                    {
                        <div class="data-item order-event-item">
                            <strong>@order.OrderId</strong>
                            <span>@order.Status</span>
                            <span class="amount">$@order.Amount.ToString("F2")</span>
                            <small>@order.Timestamp.ToString("HH:mm:ss")</small>
                        </div>
                    }
                </div>
            </div>
        }

        @if (debouncedClicks.Any())
        {
            <div class="data-panel">
                <h4>ğŸ”˜ Ú©Ù„ÛŒÚ© Ù‡Ø§ÛŒ Ø¯Ú©Ù…Ù‡ (Ø¨Ø§ Debounce) / Button Clicks (Debounced)</h4>
                <div class="data-list">
                    @foreach (var click in debouncedClicks.Take(5))
                    {
                        <div class="data-item button-click-item">
                            <strong>@click.ButtonId</strong>
                            <span>@click.UserId</span>
                            <small>@click.Timestamp.ToString("HH:mm:ss")</small>
                        </div>
                    }
                </div>
            </div>
        }
    </div>

    <div class="combined-events-panel">
        <h4>ğŸ”— Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ ØªØ±Ú©ÛŒØ¨ÛŒ / Combined Events</h4>
        <div class="combined-list">
            @foreach (var combinedEvent in combinedEvents.Take(10))
            {
                <div class="combined-item">
                    <span class="event-type @combinedEvent.Type.ToLower().Replace("_", "-")">@combinedEvent.Type</span>
                    <span>@combinedEvent.Description</span>
                    <small>@combinedEvent.Timestamp.ToString("HH:mm:ss")</small>
                </div>
            }
        </div>
    </div>

    <div class="info-panel">
        <p>
            <strong>Ù…ÙØ§Ù‡ÛŒÙ… Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡:</strong><br>
            - Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ Ø¨Ø§ Subscribe<br>
            - Debounce Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú©Ù„ÛŒÚ©â€ŒÙ‡Ø§ÛŒ Ø³Ø±ÛŒØ¹<br>
            - Merge Ø¨Ø±Ø§ÛŒ ØªØ±Ú©ÛŒØ¨ Ú†Ù†Ø¯ÛŒÙ† Ø¬Ø±ÛŒØ§Ù† Ø±ÙˆÛŒØ¯Ø§Ø¯<br>
            - Ù†Ù…Ø§ÛŒØ´ Ø¨Ù„Ø§Ø¯Ø±Ù†Ú¯ ØªØºÛŒÛŒØ±Ø§Øª Ø¯Ø± UI
        </p>
        <p>
            <strong>Concepts demonstrated:</strong><br>
            - Event handling with Subscribe<br>
            - Debounce to prevent rapid clicks<br>
            - Merge to combine multiple event streams<br>
            - Real-time UI updates
        </p>
    </div>
</div>

<style>
.event-section {
    margin: 20px 0;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background-color: #f9f9f9;
}

.section-title {
    color: #2c3e50;
    margin-bottom: 15px;
    text-align: center;
}

.controls {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    justify-content: center;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.3s;
}

.btn-primary { background-color: #007bff; color: white; }
.btn-primary:hover { background-color: #0056b3; }

.btn-info { background-color: #17a2b8; color: white; }
.btn-info:hover { background-color: #138496; }

.btn-secondary { background-color: #6c757d; color: white; }
.btn-secondary:hover { background-color: #545b62; }

.btn-warning { background-color: #ffc107; color: black; }
.btn-warning:hover { background-color: #e0a800; }

.data-display {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.data-panel {
    background: white;
    padding: 15px;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.data-panel h4 {
    margin: 0 0 10px 0;
    color: #495057;
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 5px;
}

.data-list {
    max-height: 200px;
    overflow-y: auto;
}

.data-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
    margin: 4px 0;
    background: #f8f9fa;
    border-radius: 4px;
    border-left: 4px solid #6c757d;
}

.user-action-item { border-left-color: #007bff; }
.system-event-item { border-left-color: #17a2b8; }
.order-event-item { border-left-color: #28a745; }
.button-click-item { border-left-color: #ffc107; }

.action-type {
    background-color: #e9ecef;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.9em;
}

.event-type, .event-type.info, .event-type.warn, .event-type.error, .event-type.debug {
    font-weight: bold;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.8em;
}

.event-type.info { background-color: #d1ecf1; color: #0c5460; }
.event-type.warn { background-color: #fff3cd; color: #856404; }
.event-type.error { background-color: #f8d7da; color: #721c24; }
.event-type.debug { background-color: #e2e3e5; color: #383d41; }

.amount { font-weight: bold; color: #28a745; }

.combined-events-panel {
    background: white;
    padding: 15px;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.combined-events-panel h4 {
    margin: 0 0 10px 0;
    color: #495057;
    border-bottom: 2px solid #6f42c1;
    padding-bottom: 5px;
}

.combined-list {
    max-height: 150px;
    overflow-y: auto;
}

.combined-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px;
    margin: 3px 0;
    background: #f8f9ff;
    border-radius: 4px;
    border-left: 4px solid #6f42c1;
}

.combined-item .event-type {
    background-color: #e9ecef;
    color: #495057;
}

.combined-item .event-type.user-action { background-color: #cce5ff; color: #004085; }
.combined-item .event-type.system-event { background-color: #d1ecf1; color: #0c5460; }

.data-item small, .combined-item small {
    color: #6c757d;
    font-size: 0.8em;
}

.info-panel {
    background: #e7f3ff;
    padding: 15px;
    border-radius: 6px;
    border-left: 4px solid #007bff;
}

.info-panel p {
    margin: 5px 0;
    line-height: 1.6;
}
</style>

@code {
    private List<UserAction> userActions = new();
    private List<SystemEvent> systemEvents = new();
    private List<OrderEvent> orderEvents = new();
    private List<ButtonClick> debouncedClicks = new();
    private List<EventBase> combinedEvents = new();

    private bool isUserActionsActive;
    private bool isSystemEventsActive;
    private bool isOrderEventsActive;

    private IDisposable? userActionsSubscription;
    private IDisposable? systemEventsSubscription;
    private IDisposable? orderEventsSubscription;
    private IDisposable? debouncedClicksSubscription;
    private IDisposable? combinedEventsSubscription;

    protected override void OnInitialized()
    {
        // Initialize debounced clicks subscription
        debouncedClicksSubscription = EventService.DebouncedButtonClicks.Subscribe(click =>
        {
            InvokeAsync(() =>
            {
                debouncedClicks.Insert(0, click);
                if (debouncedClicks.Count > 10) debouncedClicks.RemoveAt(10);
                StateHasChanged();
            });
        });

        // Initialize combined events subscription
        combinedEventsSubscription = EventService.CombinedEvents.Subscribe(combinedEvent =>
        {
            InvokeAsync(() =>
            {
                combinedEvents.Insert(0, combinedEvent);
                if (combinedEvents.Count > 15) combinedEvents.RemoveAt(15);
                StateHasChanged();
            });
        });
    }

    private void StartUserActions()
    {
        if (isUserActionsActive)
        {
            userActionsSubscription?.Dispose();
            isUserActionsActive = false;
        }
        else
        {
            EventService.StartUserActionsStream();
            userActionsSubscription = EventService.UserActions.Subscribe(action =>
            {
                InvokeAsync(() =>
                {
                    userActions.Insert(0, action);
                    if (userActions.Count > 15) userActions.RemoveAt(15);
                    StateHasChanged();
                });
            });
            isUserActionsActive = true;
        }
    }

    private void StartSystemEvents()
    {
        if (isSystemEventsActive)
        {
            systemEventsSubscription?.Dispose();
            isSystemEventsActive = false;
        }
        else
        {
            EventService.StartSystemEventsStream();
            systemEventsSubscription = EventService.SystemEvents.Subscribe(sysEvent =>
            {
                InvokeAsync(() =>
                {
                    systemEvents.Insert(0, sysEvent);
                    if (systemEvents.Count > 15) systemEvents.RemoveAt(15);
                    StateHasChanged();
                });
            });
            isSystemEventsActive = true;
        }
    }

    private void StartOrderEvents()
    {
        if (isOrderEventsActive)
        {
            orderEventsSubscription?.Dispose();
            isOrderEventsActive = false;
        }
        else
        {
            EventService.StartOrderEventsStream();
            orderEventsSubscription = EventService.OrderEvents.Subscribe(order =>
            {
                InvokeAsync(() =>
                {
                    orderEvents.Insert(0, order);
                    if (orderEvents.Count > 15) orderEvents.RemoveAt(15);
                    StateHasChanged();
                });
            });
            isOrderEventsActive = true;
        }
    }

    private void SimulateButtonClick()
    {
        var buttonId = $"btn-{new Random().Next(1, 5)}";
        var userId = $"user{new Random().Next(1, 6)}";
        EventService.SimulateButtonClick(buttonId, userId);
    }

    public void Dispose()
    {
        userActionsSubscription?.Dispose();
        systemEventsSubscription?.Dispose();
        orderEventsSubscription?.Dispose();
        debouncedClicksSubscription?.Dispose();
        combinedEventsSubscription?.Dispose();
    }
}


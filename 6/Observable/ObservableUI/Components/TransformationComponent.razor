@using ObservableUI.Services
@using System.Reactive.Linq
@inject TransformationService TransformationService
@implements IDisposable

<div class="transformation-section">
    <h3 class="section-title">ğŸ”„ ØªØ¨Ø¯ÛŒÙ„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ / Data Transformation</h3>

    <div class="controls">
        <button class="btn btn-primary" @onclick="StartProductsStream">
            @(isProductsActive ? "ØªÙˆÙ‚Ù Ù…Ø­ØµÙˆÙ„Ø§Øª" : "Ø´Ø±ÙˆØ¹ Ù…Ø­ØµÙˆÙ„Ø§Øª") /
            @(isProductsActive ? "Stop Products" : "Start Products")
        </button>

        <button class="btn btn-success" @onclick="StartSensorStream">
            @(isSensorActive ? "ØªÙˆÙ‚Ù Ø³Ù†Ø³ÙˆØ±Ù‡Ø§" : "Ø´Ø±ÙˆØ¹ Ø³Ù†Ø³ÙˆØ±Ù‡Ø§") /
            @(isSensorActive ? "Stop Sensors" : "Start Sensors")
        </button>

        <button class="btn btn-info" @onclick="StartUserActivities">
            @(isUserActivitiesActive ? "ØªÙˆÙ‚Ù ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§" : "Ø´Ø±ÙˆØ¹ ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§") /
            @(isUserActivitiesActive ? "Stop Activities" : "Start Activities")
        </button>
    </div>

    <div class="filters-section">
        <div class="filter-controls">
            <label>Ø­Ø¯Ø§Ù‚Ù„ Ù‚ÛŒÙ…Øª Ú¯Ø±Ø§Ù†â€ŒÙ‚ÛŒÙ…Øª / Min Expensive Price: $<input type="number" @bind="expensivePriceThreshold" @bind:event="oninput" min="0" step="10" /></label>
            <label>Ù†Ø±Ø® ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ ÛŒÙˆØ±Ùˆ / EUR Conversion Rate: <input type="number" @bind="eurRate" @bind:event="oninput" min="0" step="0.1" /></label>
            <label>Ø¯Ø±ØµØ¯ ØªØ®ÙÛŒÙ / Discount %: <input type="number" @bind="discountPercent" @bind:event="oninput" min="0" max="50" /></label>
        </div>
    </div>

    <div class="data-display">
        @if (products.Any())
        {
            <div class="data-panel">
                <h4>ğŸ“¦ Ù…Ø­ØµÙˆÙ„Ø§Øª / Products</h4>
                <div class="data-list">
                    @foreach (var product in products.Take(6))
                    {
                        <div class="data-item product-item">
                            <strong>@product.Name</strong>
                            <span class="category">@product.Category</span>
                            <span class="price">$@product.Price.ToString("F2")</span>
                            <small>@product.Timestamp.ToString("HH:mm:ss")</small>
                        </div>
                    }
                </div>
            </div>
        }

        @if (expensiveProducts.Any())
        {
            <div class="data-panel">
                <h4>ğŸ’° Ù…Ø­ØµÙˆÙ„Ø§Øª Ú¯Ø±Ø§Ù†â€ŒÙ‚ÛŒÙ…Øª (ÙÛŒÙ„ØªØ± Ø´Ø¯Ù‡) / Expensive Products (Filtered)</h4>
                <div class="data-list">
                    @foreach (var product in expensiveProducts.Take(6))
                    {
                        <div class="data-item expensive-item">
                            <strong>@product.Name</strong>
                            <span class="category">@product.Category</span>
                            <span class="price">$@product.Price.ToString("F2")</span>
                            <small>@product.Timestamp.ToString("HH:mm:ss")</small>
                        </div>
                    }
                </div>
            </div>
        }

        @if (productsInEUR.Any())
        {
            <div class="data-panel">
                <h4>ğŸ’± Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¨Ù‡ ÛŒÙˆØ±Ùˆ (ØªØ¨Ø¯ÛŒÙ„ Ø´Ø¯Ù‡) / Products in EUR (Converted)</h4>
                <div class="data-list">
                    @foreach (var product in productsInEUR.Take(6))
                    {
                        <div class="data-item eur-item">
                            <strong>@product.Name</strong>
                            <span class="category">@product.Category</span>
                            <span class="price">â‚¬@product.PriceEUR.ToString("F2")</span>
                            <small>@product.Timestamp.ToString("HH:mm:ss")</small>
                        </div>
                    }
                </div>
            </div>
        }

        @if (cleanedSensorData.Any())
        {
            <div class="data-panel">
                <h4>ğŸ§¹ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø³Ù†Ø³ÙˆØ± Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡ / Cleaned Sensor Data</h4>
                <div class="data-list">
                    @foreach (var sensor in cleanedSensorData.Take(6))
                    {
                        <div class="data-item sensor-item">
                            <strong>@sensor.SensorId</strong>
                            <span>@sensor.Temperature.ToString("F1")Â°C</span>
                            <span>@sensor.Humidity.ToString("F1")%</span>
                            <span class="quality @sensor.Quality.ToLower()">@sensor.Quality</span>
                            <small>@sensor.Timestamp.ToString("HH:mm:ss")</small>
                        </div>
                    }
                </div>
            </div>
        }

        @if (aggregatedSensorData.Any())
        {
            <div class="data-panel">
                <h4>ğŸ“Š Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø³Ù†Ø³ÙˆØ± ØªØ¬Ù…ÛŒØ¹ Ø´Ø¯Ù‡ / Aggregated Sensor Data</h4>
                <div class="aggregated-data">
                    @if (aggregatedSensorData.Count > 0)
                    {
                        var latest = aggregatedSensorData.Last();
                        <div class="aggregated-item">
                            <div><strong>Ø´Ù…Ø§Ø±Ø´ / Count:</strong> @latest.Count</div>
                            <div><strong>Ù…Ø¬Ù…ÙˆØ¹ Ø¯Ù…Ø§ / Sum Temp:</strong> @latest.SumTemperature.ToString("F1")Â°C</div>
                            <div><strong>Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† / Average:</strong> @latest.AverageTemperature.ToString("F1")Â°C</div>
                            <div><strong>Ø­Ø¯Ø§Ù‚Ù„ / Min:</strong> @latest.MinTemperature.ToString("F1")Â°C</div>
                            <div><strong>Ø­Ø¯Ø§Ú©Ø«Ø± / Max:</strong> @latest.MaxTemperature.ToString("F1")Â°C</div>
                            <div><small>Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ / Last Update: @latest.LastUpdate.ToString("HH:mm:ss")</small></div>
                        </div>
                    }
                </div>
            </div>
        }

        @if (discountedProducts.Any())
        {
            <div class="data-panel">
                <h4>ğŸ·ï¸ Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¨Ø§ ØªØ®ÙÛŒÙ / Discounted Products</h4>
                <div class="data-list">
                    @foreach (var product in discountedProducts.Take(6))
                    {
                        <div class="data-item discount-item">
                            <strong>@product.Name</strong>
                            <span class="original-price">$@product.OriginalPrice.ToString("F2")</span>
                            <span class="discounted-price">$@product.DiscountedPrice.ToString("F2")</span>
                            <span class="discount">(-@product.DiscountPercent.ToString("F0")%)</span>
                            <small>@product.Timestamp.ToString("HH:mm:ss")</small>
                        </div>
                    }
                </div>
            </div>
        }

        @if (userActivityStats.Any())
        {
            <div class="data-panel">
                <h4>ğŸ“ˆ Ø¢Ù…Ø§Ø± ÙØ¹Ø§Ù„ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† / User Activity Stats</h4>
                <div class="stats-list">
                    @foreach (var stat in userActivityStats.Take(8))
                    {
                        <div class="stat-item">
                            <strong>@stat.UserId</strong>
                            <span>@stat.TotalActions Ø§Ù‚Ø¯Ø§Ù… / actions</span>
                            <small>Ø¢Ø®Ø±ÛŒÙ† / Last: @stat.LastActivity.ToString("HH:mm:ss")</small>
                        </div>
                    }
                </div>
            </div>
        }

        @if (activitySummary.Any())
        {
            <div class="data-panel">
                <h4>ğŸ“‹ Ø®Ù„Ø§ØµÙ‡ ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§ / Activity Summary</h4>
                <div class="data-list">
                    @foreach (var activity in activitySummary.Take(6))
                    {
                        <div class="data-item activity-item">
                            <strong>@activity.UserId</strong>
                            <span>@activity.Action</span>
                            <span class="category @activity.Category.ToLower()">@activity.Category</span>
                            <span class="@(activity.IsHighValue ? "high-value" : "")">@activity.Duration ms</span>
                            <small>@activity.Timestamp.ToString("HH:mm:ss")</small>
                        </div>
                    }
                </div>
            </div>
        }
    </div>

    <div class="info-panel">
        <p>
            <strong>Ù…ÙØ§Ù‡ÛŒÙ… Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡:</strong><br>
            - Where Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„ØªØ± Ú©Ø±Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§<br>
            - Select Ø¨Ø±Ø§ÛŒ ØªØ¨Ø¯ÛŒÙ„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§<br>
            - Distinct Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù ØªÚ©Ø±Ø§Ø±ÛŒâ€ŒÙ‡Ø§<br>
            - GroupBy Ùˆ Scan Ø¨Ø±Ø§ÛŒ ØªØ¬Ù…ÛŒØ¹ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§<br>
            - ØªØ¨Ø¯ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒÚ†ÛŒØ¯Ù‡ Ø¨Ø§ LINQ
        </p>
        <p>
            <strong>Concepts demonstrated:</strong><br>
            - Where for data filtering<br>
            - Select for data transformation<br>
            - Distinct for removing duplicates<br>
            - GroupBy and Scan for data aggregation<br>
            - Complex transformations with LINQ
        </p>
    </div>
</div>

<style>
.transformation-section {
    margin: 20px 0;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background-color: #f9f9f9;
}

.section-title {
    color: #2c3e50;
    margin-bottom: 15px;
    text-align: center;
}

.controls {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
    justify-content: center;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.3s;
}

.btn-primary { background-color: #007bff; color: white; }
.btn-primary:hover { background-color: #0056b3; }

.btn-success { background-color: #28a745; color: white; }
.btn-success:hover { background-color: #1e7e34; }

.btn-info { background-color: #17a2b8; color: white; }
.btn-info:hover { background-color: #138496; }

.filters-section {
    background: white;
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.filter-controls {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
}

.filter-controls label {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
    font-weight: bold;
    color: #495057;
}

.filter-controls input {
    width: 80px;
    padding: 5px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    text-align: center;
}

.data-display {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.data-panel {
    background: white;
    padding: 15px;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.data-panel h4 {
    margin: 0 0 10px 0;
    color: #495057;
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 5px;
}

.data-list, .stats-list {
    max-height: 200px;
    overflow-y: auto;
}

.data-item, .stat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
    margin: 4px 0;
    background: #f8f9fa;
    border-radius: 4px;
    border-left: 4px solid #6c757d;
}

.product-item { border-left-color: #007bff; }
.expensive-item { border-left-color: #28a745; }
.eur-item { border-left-color: #17a2b8; }
.sensor-item { border-left-color: #ffc107; }
.discount-item { border-left-color: #dc3545; }
.activity-item { border-left-color: #6f42c1; }

.category {
    background-color: #e9ecef;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.8em;
}

.price { font-weight: bold; color: #007bff; }

.quality.valid { color: #28a745; font-weight: bold; }
.quality.invalid { color: #dc3545; font-weight: bold; }

.aggregated-data {
    padding: 10px;
    background: #f8f9fa;
    border-radius: 4px;
}

.aggregated-item {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
}

.aggregated-item div {
    background: white;
    padding: 8px;
    border-radius: 4px;
    text-align: center;
    border: 1px solid #dee2e6;
}

.original-price { text-decoration: line-through; color: #6c757d; }
.discounted-price { font-weight: bold; color: #28a745; }
.discount { color: #dc3545; font-weight: bold; }

.high-value { color: #ffc107; font-weight: bold; }

.stat-item {
    justify-content: space-between;
    background: #e7f3ff;
    border-left-color: #007bff;
}

.data-item small, .stat-item small {
    color: #6c757d;
    font-size: 0.8em;
}

.info-panel {
    background: #e7f3ff;
    padding: 15px;
    border-radius: 6px;
    border-left: 4px solid #007bff;
}

.info-panel p {
    margin: 5px 0;
    line-height: 1.6;
}
</style>

@code {
    private List<Product> products = new();
    private List<Product> expensiveProducts = new();
    private List<ProductEUR> productsInEUR = new();
    private List<ProcessedSensorData> cleanedSensorData = new();
    private List<AggregatedSensorData> aggregatedSensorData = new();
    private List<DiscountedProduct> discountedProducts = new();
    private List<UserActivityStats> userActivityStats = new();
    private List<ActivitySummary> activitySummary = new();

    private bool isProductsActive;
    private bool isSensorActive;
    private bool isUserActivitiesActive;

    private decimal expensivePriceThreshold = 500;
    private decimal eurRate = 0.85m;
    private int discountPercent = 10;

    private IDisposable? productsSubscription;
    private IDisposable? expensiveProductsSubscription;
    private IDisposable? productsInEURSubscription;
    private IDisposable? cleanedSensorSubscription;
    private IDisposable? aggregatedSensorSubscription;
    private IDisposable? discountedProductsSubscription;
    private IDisposable? userActivityStatsSubscription;
    private IDisposable? activitySummarySubscription;

    protected override void OnInitialized()
    {
        // Initialize subscriptions with current parameters
        InitializeSubscriptions();
    }

    private void InitializeSubscriptions()
    {
        // Clean up existing subscriptions
        Dispose();

        // Products subscription
        productsSubscription = TransformationService.Products.Subscribe(product =>
        {
            InvokeAsync(() =>
            {
                products.Insert(0, product);
                if (products.Count > 20) products.RemoveAt(20);
                StateHasChanged();
            });
        });

        // Expensive products subscription
        expensiveProductsSubscription = TransformationService.ExpensiveProducts(expensivePriceThreshold).Subscribe(product =>
        {
            InvokeAsync(() =>
            {
                expensiveProducts.Insert(0, product);
                if (expensiveProducts.Count > 20) expensiveProducts.RemoveAt(20);
                StateHasChanged();
            });
        });

        // Products in EUR subscription
        productsInEURSubscription = TransformationService.ProductsInEUR(eurRate).Subscribe(product =>
        {
            InvokeAsync(() =>
            {
                productsInEUR.Insert(0, product);
                if (productsInEUR.Count > 20) productsInEUR.RemoveAt(20);
                StateHasChanged();
            });
        });

        // Cleaned sensor data subscription
        cleanedSensorSubscription = TransformationService.CleanedSensorData.Subscribe(sensor =>
        {
            InvokeAsync(() =>
            {
                cleanedSensorData.Insert(0, sensor);
                if (cleanedSensorData.Count > 20) cleanedSensorData.RemoveAt(20);
                StateHasChanged();
            });
        });

        // Aggregated sensor data subscription
        aggregatedSensorSubscription = TransformationService.AggregatedSensorData.Subscribe(aggregated =>
        {
            InvokeAsync(() =>
            {
                aggregatedSensorData.Add(aggregated);
                if (aggregatedSensorData.Count > 10) aggregatedSensorData.RemoveAt(0);
                StateHasChanged();
            });
        });

        // Discounted products subscription
        discountedProductsSubscription = TransformationService.DiscountedProducts(discountPercent).Subscribe(product =>
        {
            InvokeAsync(() =>
            {
                discountedProducts.Insert(0, product);
                if (discountedProducts.Count > 20) discountedProducts.RemoveAt(20);
                StateHasChanged();
            });
        });

        // User activity stats subscription
        userActivityStatsSubscription = TransformationService.UserActivityStats.Subscribe(stat =>
        {
            InvokeAsync(() =>
            {
                var existing = userActivityStats.FirstOrDefault(s => s.UserId == stat.UserId);
                if (existing != null)
                {
                    userActivityStats.Remove(existing);
                }
                userActivityStats.Add(stat);
                if (userActivityStats.Count > 10) userActivityStats.RemoveAt(0);
                StateHasChanged();
            });
        });

        // Activity summary subscription
        activitySummarySubscription = TransformationService.ActivitySummary.Subscribe(activity =>
        {
            InvokeAsync(() =>
            {
                activitySummary.Insert(0, activity);
                if (activitySummary.Count > 20) activitySummary.RemoveAt(20);
                StateHasChanged();
            });
        });
    }

    private void StartProductsStream()
    {
        if (isProductsActive)
        {
            isProductsActive = false;
        }
        else
        {
            TransformationService.StartProductsStream();
            isProductsActive = true;
        }
    }

    private void StartSensorStream()
    {
        if (isSensorActive)
        {
            isSensorActive = false;
        }
        else
        {
            TransformationService.StartSensorDataStream();
            isSensorActive = true;
        }
    }

    private void StartUserActivities()
    {
        if (isUserActivitiesActive)
        {
            isUserActivitiesActive = false;
        }
        else
        {
            TransformationService.StartUserActivitiesStream();
            isUserActivitiesActive = true;
        }
    }

    private void UpdateParameters()
    {
        // Reinitialize subscriptions with new parameters
        InitializeSubscriptions();
    }

    public void Dispose()
    {
        productsSubscription?.Dispose();
        expensiveProductsSubscription?.Dispose();
        productsInEURSubscription?.Dispose();
        cleanedSensorSubscription?.Dispose();
        aggregatedSensorSubscription?.Dispose();
        discountedProductsSubscription?.Dispose();
        userActivityStatsSubscription?.Dispose();
        activitySummarySubscription?.Dispose();
    }
}

